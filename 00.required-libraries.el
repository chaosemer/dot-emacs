;; A better defmacro.
(defmacro defmacro+ (name args &rest body)
  "Like `defmacro*', but also attempts to figure out the indenting"
  (let ((body-index (position-if (lambda (arg) (member arg '(&body &rest)))
                                 (remove '&optional args))))
    `(progn
       (setf (get ',name 'lisp-indent-function) ,body-index)
       (defmacro* ,name ,args ,@body))))

;; A more useable user-level way to add hooks.
(defvar hook-minor-mode-*hooks* (make-hash-table :test #'eq))
(defun hook-minor-mode-attach (hook function)
  (when (gethash hook hook-minor-mode-*hooks*)
    (remove-hook hook (gethash hook hook-minor-mode-*hooks*)))
  (add-hook hook function)
  (setf (gethash hook hook-minor-mode-*hooks*) function))

(defmacro+ hook-minor-mode (hook &body modes)
  "Hook each minor mode MODE on HOOK."
  (let ((body (loop for expr in modes
                    if (and (symbolp expr) (fboundp expr))
                      collect (list expr 1)
                    else if (listp expr)
                      collect expr
                    else do (error "~A does not appear to name a minor mode."))))
    `(hook-minor-mode-attach ',hook (lambda () "Auto-generated by `hook-minor-mode'"
                                      ,@body))))

;; Convenient shorthand for requiring without an error.
(defun require-noerror (feature &optional filename)
  (require feature filename t))

;; Patches for buggy/old emacs code:
(unless (fboundp 'warn)
  (message "Using old compatibility mode for `warn'")
  (defalias 'warn 'message))
(unless (fboundp 'cua-mode)
  (require 'cua)
  (warn "Using old compatibility mode for `cua-mode'")
  (defalias 'cua-mode 'CUA-mode))
(unless (fboundp 'grep-tree)
  (warn "Using old compatibility mode for `grep-tree'")
  (defalias 'grep-tree 'grep-find))
(unless (fboundp 'global-semantic-idle-completions-mode)
  (warn "Using old compatibility mode for `global-semantic-idle-completions-mode'")
  (defalias 'global-semantic-idle-completions-mode 'global-semantic-idle-scheduler-mode))
(unless (fboundp 'x-show-tip)
  (warn "Modifying `tooltip-mode' to do nothing or error.")
  (defun tooltip-mode (&optional arg)
    (interactive (list (prefix-numeric-value current-prefix-arg)))
    (when (> arg 0)
      (error "Sorry, tooltips are not yet available on this system"))))
(unless (fboundp 'custom-autoload)
  (warn "Using old compatibility mode for `custom-autoload'")
  (defalias 'custom-autoload 'custom-add-load))
(let ((movement-functions '(backward-sexp forward-sexp backward-up-list up-list down-list)))
  (unless (every (lambda (symbol) (eq 'move (get symbol 'CUA)))
                 movement-functions)
    (warn "Adding CUA property to all symbols that need it.")
    (dolist (symbol movement-functions)
      (setf (get symbol 'CUA) 'move))))

(defsetf lookup-key define-key)

(require 'bar-cursor)
(warn "Using replacement `bar-cursor-set-cursor'.")
(defun bar-cursor-set-cursor (&optional frame)
  "Replacement for buggy `bar-cursor-set-cursor' in `bar-cursor.el'."
  (if (and bar-cursor-mode (not overwrite-mode))
      (bar-cursor-set-cursor-type 'bar frame)
    (bar-cursor-set-cursor-type 'box frame)))
